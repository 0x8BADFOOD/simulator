# Steps to annotate map for LGSVL simulator
- Open `MapToolUtilEdit` in `Unity` -> `Window` -> `Map Tool Panel`
	- ![](images/annotation-window-menu.png)
- Defaultly, map annotation is not shown. Click `Show/Hide Map` to show existing map annotation.
- Before annotation, select correct `Parent Object` in MapToolUtilEdit, for example `Map`, then every new object you create will be under `Map` object.	
	- ![](images/annotation-mapToolPanel.PNG)
- After annotation is done, remember to save: go to `Map` level, click `Apply` 


## Annotate lanes
- Create temp map waypoint
	- click `Create Temp Map Waypoint` button to create a new point in the center of current scene window
	- ![tempMapWayPoint](images/annotation-tempWayPoint.PNG)
- Make Lane
	- Select the waypoint, `ctrl` + `d` to duplicate and move them to desired positions
		- ![](images/annotation-threeWayPoints.PNG)
	- Connect them to make a lane
		- Sequentially select points
		- Click `Make Lane (MapLaneSegmentBuilder)` button to make a lane
		-  ![](images/annotation-makeLane.PNG)
	- You can make `StopLine` and `BoundaryLine` in similar way using the other two buttons below `Make Lane (MapLaneSegmentBuilder)`
		- ![](images/annotation-stopLine+boundaryLine.PNG)
- In-Between Lane Generation
	- You can make lanes by creating temp points and connect them, you can also make an in-between lane easily when you have two existing lanes and you want to make another lane to connect those two lanes
	- Select both lanes, create the new in-between lane by clicking `Auto Generate In-Between Lane` button at the bottom of MapToolUtilEdit panel
		- ![](images/annotation-makeInBetweenLane.PNG)
	- Because you might want to connect lanes of different angles and do it multiple times, we provide the ability of saving different presets to generate in-between lanes. 
		- Larger value of `Tangent` make the lane more straight
		- You can also change the number of presets by changing `Preset Count`
		- Check `Offset Start/End Points` if you want a small offset between the end points of the new lane and the end point of the selected two lanes, otherwise those points will overlap with each other completely.
- Link neighbor lanes
	- After you create parallel lanes, you need to link them to have correct relations 
	- Link neighbor lanes of same direction
		- Select lanes sequentially from left/right
		- Click `Link Neighbor Lanes from Left/Right` to link them
		- After link, you can check it in every lane object's inspector
		- ![](images/annotation-neighborLaneLink.PNG)
	- Link reverse neighbor lanes
		- Select both reverse neighbor lanes
		- Click `Link Reverse Neighbor Lanes`
		- ![](images/annotation-reverseNeighborLaneLink.PNG)
		- In the above screenshot, double yellow boundary lane can be generated by creating BoundaryLine and change its `Line Type` from `SOLID_WHITE` to `DOUBLE_YELLOW` in its inspector
	- If anything wrong, you can nullify all neighbor lane fields by clicking `Nullify All Neighbor Lane Fields` button
- Set correct left/right boundary type
	- Rightmost lane typically has a right boundary type of `CURB`
		- ![](images/annotation-boundary-CURB.PNG)
	- Middle lanes typically has a left boundary type of `DOUBLE_YELLOW`
		- ![enter image description here](images/annotation-boundary-DoubleYellow.PNG)


## Traffic light annotation
- Make SignalLight
	- Select `local` instead of `global` in both Unity and MapToolUtilEdit panel
	- Find one traffic light that is already made whose type is `HDMapSignalLight` (with a red boundary box)
	- Load template by clicking `Load SignalLight Template` button
		- ![enter image description here](images/annotation-load-SignalLight-Template.PNG)
		- In above screenshot, the left SignalLight (type: HDMapSignalLight) has a red boundary box and the right one (type: MapSignalLight) doesn't have
	- Make sure relative axis relation are selected correctly
		- In the row of `Make SignalLight(HDMapSignalLightBuilder)`, select `Aim` as `Y Neg`, `Up` as `Z Pos`
			- ![enter image description here](images/annotation-set_axis.PNG)
	- Select your desired empty signal light holder
		- ![enter image description here](images/annotation-select-empty-signal-holder.PNG)
	- Click `Make SignalLight (HDMapSignalLightBuilder)` to generate the signal light
		- ![enter image description here](images/annotation-apply-signalLight.PNG)
	- Note: currently, `HDMapSignalLightBuilder` is for Apollo, one per road is enough. `MapSignalLightBuilder` is for Autoware, it needs one per every lane. There is a converter button at the bottom of `MapToolUtilEdit` to get `MapSignalLightBuilder` from `HDMapSignalLightBuilder`
- Link the created traffic light to the corresponding stopline
	- Select both signallight and the stopline
	- Click `Link SignalLight and StopLine` in `Advanced Utils` section in the panel
		- ![enter image description here](images/annotation-link-signallight-stopline.PNG)
- Similarly, you can create stop sign and link the stop sign to the corresponding stopline using corresponding buttons.


## Create Traffic Pole and link to contained Signal light (this is an additional step for Autoware)
	
- Select desired traffic pole 
	- make sure `Local` and `Z Pos` are selected
	- Click `Make Traffic Pole (VectorMapPoleBuilder)`
		- ![enter imagke description here](images/annotation-create-trafficpole.PNG)
		- Press `w` so you can rotate the created pole.
- Rotate the bounding box of the pole to include corresponding signal lights in it
	- ![enter image description here](images/annotation-traffic-pole-after-rotation.PNG)
	- Click `Link to Contained SignalLights` in the traffic pole's inspector
	- OR select both signal lights and traffic pole, click `Link TrafficPole and SignalLight` in the MapToolUtilEdit panel
- For traffic poles in multiple intersections, to save time you can
	- Create and rotate for all `VectorMapPole`s
	- Select all `VectorMapPole` in `Hierachy` tab -> `Link Selected TrafficPoles To Contained SignalLights`
- Notes for stopline
	- For Autoware needs two waypoints for every lane, i.e.: five waypoints are needed for four lanes, three waypoints are needed for two lanes, etc. Apollo doesn't have such requirement. 

## Export map files
- For Apollo, select `HDMapTool` in `Hierachy` tab, click `Export HD Map`
	- ![enter image description here](images/annotation-exportHDMap.PNG)
	- If your map annotation is correct, you will see `Successfully generated and exported Apollo HD Map!` in the Console
	- You can find the generated map file in `hd_map` folder under the root of the repo
- It is similar for Autoware, select `VectorMapTool`, click `Export Vector Map`


